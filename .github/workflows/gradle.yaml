name: Java CI with Gradle

on:
  push:
    branches: [ "master" ,"main"]
  # pull_request:
  #  branches: [ "master" ]

permissions:
  contents: read
  id-token: write # 必须保留，用于OIDC令牌生成

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      OIDC_PROVIDER: 'zhltest'
      OIDC_AUDIENCE: 'zhltest'
      POC_URL: 'https://demo.jfrogchina.com'

    steps:
      # --- 以下OIDC令牌获取步骤完全保留，无需更改 ---
      - name: Get id token
        run: |
            ID_TOKEN=$(curl -sLS -H "User-Agent: actions/oidc-client" -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
            "${ACTIONS_ID_TOKEN_REQUEST_URL}&audience=${OIDC_AUDIENCE}" | jq .value | tr -d '"')
            echo "ID_TOKEN=${ID_TOKEN}" >> $GITHUB_ENV

      - name: Exchange token with access
        env:
            ID_TOKEN: ${{ env.ID_TOKEN }}
        run: |
            ACCESS_TOKEN=$(curl -XPOST -H "Content-Type: application/json" "https://demo.jfrogchina.com/access/api/v1/oidc/token" -d "{\"grant_type\": \"urn:ietf:params:oauth:grant-type:token-exchange\", \"subject_token_type\":\"urn:ietf:params:oauth:token-type:id_token\", \"subject_token\": \"${ID_TOKEN}\", \"provider_name\": \"${OIDC_PROVIDER}\"}" | jq .access_token | tr -d '"' )
            echo "ACCESS_TOKEN=${ACCESS_TOKEN}" >> $GITHUB_ENV
            printenv
      # --- OIDC步骤结束 ---

      - uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v3
        with:
          java-version: '8'
          distribution: 'temurin'
          # 关键变更1: 将缓存类型从'maven'改为'gradle'
          cache: 'gradle' # 这会自动缓存~/.gradle/caches和wrapper目录[citation:9]

      # 关键变更2: 使用Gradle官方Actions优化构建[citation:8]
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4 # 官方插件，提供构建扫描、缓存优化等功能[citation:8]

      # 关键变更4: 部署步骤适配Gradle（根据你的build.gradle.kts配置调整）
      - name: Publish to Artifactory with Gradle
        env:
          # 将OIDC交换得到的访问令牌传递给Gradle任务
          JFROG_ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          ARTIFACTORY_USER: 'hl'
          # 设置Artifactory URL和仓库，需与build.gradle.kts中的配置对应
          JFROG_MAVEN_URL: ${{ env.POC_URL }}/artifactory
          MAVEN_REPO: 'your-target-repo-key' # 请替换为实际的仓库键
        run: |
          # 直接运行你在build.gradle.kts中配置的artifactoryPublish任务
          cat > ./gradle.properties <<EOF
          currentVersion=1.0-SNAPSHOT
          ARTIFACTORY_USER=hl
          JFROG_ACCESS_TOKEN=${JFROG_ACCESS_TOKEN}
          EOF
          echo "=== 创建的 gradle.properties 文件内容 ==="
          cat ./gradle.properties
          curl -H "Authorization: Bearer $JFROG_ACCESS_TOKEN" -T gradle.properties "${POC_URL}/artifactory/zhl-generic-local/gradle.properties"
          # 3. 然后执行发布任务
          ./gradlew artifactoryPublish

